<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Маршрут №414 - Текущее положение автобусов</title>
    <style>
        /* Основные стили */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        h1 {
			font-size: 18px;
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        /* Стили карты */
        .map-wrapper {
            position: relative;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }
        
        /* Горизонтальная ориентация для десктопа */
        .map-wrapper.desktop {
            padding-bottom: 70%; /* Соотношение сторон 400x280 (viewBox) */
        }
        
        /* Вертикальная ориентация для мобильных */
        .map-wrapper.mobile {
            padding-bottom: 142.8%; /* Соотношение сторон 280x400 (viewBox) */
        }
        
        .map-overlay-elements {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        svg {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

		.overlay-container {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			pointer-events: none;
			overflow: visible;
			margin: 0;
			padding: 0;
		}
        
        /* Стили автобусов */
        .bus {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 10%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 0 5px rgba(0,0,0,0.7);
            pointer-events: none;
            background-color: rgba(225, 219, 88, 1);
			transition: transform 1s linear; /*cubic-bezier(0.2, 0.8, 0.4, 1)*/
			will-change: transform;
			top: 0;
			left: 0;
        }
        
        .forward-bus {
            border: 2px solid #3498db;
        }
        
        .backward-bus {
            border: 2px solid #9b59b6;
        }
        
        /* Стили остановок */
        .stop {
            position: absolute;
            z-index: 5;
            width: 7px;
            height: 7px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid white;
            box-shadow: 0 0 3px rgba(0,0,0,0.5);
            cursor: pointer;
            pointer-events: auto;
        }
        
        .forward-stop {
            background-color: #3498db;
        }
        
        .backward-stop {
            background-color: #9b59b6;
        }
        
        .stop-label {
            position: absolute;
            z-index: 20;
            font-size: 12px;
            background-color: rgba(255,255,255,0.95);
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            transform: translate(-50%, -100%);
            margin-top: -10px;
        }
        
        .stop:hover + .stop-label,
        .stop-label:hover {
            opacity: 1;
        }
        
        /* Стили времени */
        .real-time {
            font-size: 16px;
            text-align: center;
            margin: 15px 0;
            color: #333;
            font-weight: bold;
        }
        
        /* Стили информации об остановке */
        .stop-info {
            position: absolute !important;
            background-color: rgba(255, 255, 255, 0.95) !important;
            padding: 10px !important;
            border-radius: 8px !important;
            box-shadow: 0 0 10px rgba(0,0,0,0.2) !important;
            z-index: 30 !important;
            max-width: 250px !important;
            pointer-events: auto !important;
            transform: none !important;
            margin: 10px !important;
        }

        .stop-info.forward-info {
            font-size: calc(9px + 0.5vw) !important;
            top: 40% !important;
            left: 55% !important;
            width: auto !important;
			max-width: 50% !important;
			background-color: #e6f7ff;
			border: 1px solid #91d5ff;
        }

        .stop-info.backward-info {
            font-size: calc(9px + 0.5vw) !important;
            left: 5% !important;
            top: 66% !important;
            width: auto !important;
			max-width: 50% !important;
			background-color: #fff7e6;
			border: 1px solid #9b59b6;
		}
		/* Заголовок маршрута */
		.stop-info .route-title {
			font-size: calc(5px + 0.5vw);
			font-weight: bold;
			margin-bottom: 5px;
			text-align: center;
			color: #999999;
		}


		/* Разделитель между автобусами */
		.stop-info .bus-separator {
			margin: 5px 0;
			border: none;
			border-top: 1px dashed #ccc;
		}

		/* Блок информации об автобусе */
		.stop-info .bus-info {
			margin: 3px 0;
		}

		/* Название текущей/следующей остановки */
		.stop-info .stop-time {
			font-weight: 500;
			color: #222;
		}

		/* Время прибытия */
		.stop-info .stop-eta {
			color: #666;
			font-size: 0.9em;
			margin-top: 2px;
		}
				
        /* Стили панели расписания */
        .schedule-panel {
            position: absolute;
            top: 10px;
            right: 20px;
            width: 250px;
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            z-index: 50;
            display: none;
        }
        
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .schedule-title {
            font-weight: bold;
            margin: 0;
            font-size: 16px;
        }
        
        .close-schedule {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }
        
        .schedule-item {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        
        .past-time {
            color: #999;
            background-color: #f5f5f5;
        }
        
        .future-time {
            color: #27ae60;
            background-color: #e8f5e9;
        }
        
        .current-time {
            font-weight: bold;
            background-color: #e3f2fd;
        }
        
        .next-bus-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
            font-size: 14px;
            color: #e67e22;
        }
        
        /* Стили для стрелок */
        .arrow-line {
            position: absolute;
            z-index: 9;
            height: 2px;
            background-color: rgba(0,0,0,0.3);
            transform-origin: 0 50%;
            pointer-events: none;
			transition: transform 1s linear
			will-change: transform, width;
        }


        
        /* Медиа-запрос для мобильных устройств */
        @media (max-width: 769px) {
            .container {
                padding: 10px;
            }
            
            .real-time {
                font-size: 12px;
                text-align: left;
                margin: 15px 10px;
                color: #333;
                font-weight: bold;
            }
            
            h1 {
                font-size: 18px;
                margin-bottom: 5px;
            }
            
            .schedule-panel {
				position: absolute;
				top: 10px !important;
				right: 10px;
                width: 150px;
                padding: 10px;
            }
            
            .stop {
                width: 5px;
                height: 5px;
                border: 2px solid white;
            }
            
            .bus {
                width: 7px;
                height: 7px;
            }
			/* Заголовок маршрута */
			.stop-info .route-title {
				font-size: 12px;
			}
            .stop-info.forward-info {
                font-size: 17px;
                top: 17% !important;
                left: 55% !important;
                width: 32% !important;
            }

            .stop-info.backward-info {
                font-size: 17px;
                bottom: auto !important;
                left: 0px !important;
                right: auto !important;
                top: 65% !important;
                width: 29% !important;
            }
            
            @media (max-width: 480px) {
                h1 {
                    font-size: 12px;
                    margin-bottom: 5px;
                }
                
                .real-time {
                    font-size: 10px;
                    text-align: left;
                }
                
                .stop {
                    width: 5px;
                    height: 5px;
                    border: 1px solid white;
                }
                
                .bus {
                    width: 5px;
                    height: 5px;
                }
                
                .forward-bus {
                    border: 1px solid #3498db;
                }
                
                .backward-bus {
                    border: 1px solid #9b59b6;
                }
                
                .schedule-panel {
                    position: absolute;
                    top: 1%;
                    right: 1%;
                    width: auto;
                    padding: 4px;
                    font-size: 12px;
                }
                
                .schedule-header {
                    margin-bottom: 5px;
                    padding-bottom: 4px;
                }
                
                .schedule-title {
                    font-size: 14px;
                }
                
                .close-schedule {
                    font-size: 16px;
                }
                
                .schedule-item {
                    margin: 2px 0;
                    padding: 4px;
                }
                
                .stop-eta {
                    font-size: 20px;
                }
				/* Заголовок маршрута */
				.stop-info .route-title {
					font-size: 9px;
				}
                .stop-info.forward-info {
                    font-size: 11px;
                    top: 16% !important;
                    left: 53% !important;
                    width: 30% !important;
					bottom: auto !important;
                }

                .stop-info.backward-info {
                    font-size: 11px;
                    top: 60% !important;
                    left: 0px !important;
                    right: auto !important;
					bottom: auto !important;
                    width: 27% !important;
                }
            }
			@media (max-width: 320px) {
                h1 {
                    font-size: 8px;
                    margin-bottom: 5px;
                }
                
                .real-time {
                    font-size: 10px;
                    text-align: center;
                }
                
                .stop {
                    width: 4px;
                    height: 4px;
                    border: 1px solid white;
                }
                
                .bus {
                    width: 3px;
                    height: 3px;
                }
                
                .forward-bus {
                    border: 1px solid #3498db;
                }
                
                .backward-bus {
                    border: 1px solid #9b59b6;
                }
                
                .schedule-panel {
                    position: absolute;
                    top: 0;
                    right: 0;
                    width: auto;
                    bottom: 0;
                    padding: 4px;
                    font-size: 8px;
                }
                
                .schedule-header {
                    margin-bottom: 5px;
                    padding-bottom: 4px;
                }
                
                .schedule-title {
                    font-size: 9px;
                }
                
                .close-schedule {
                    font-size: 14px;
                }
                
                .schedule-item {
                    margin: 2px 0;
                    padding: 2px;
                }
                
                .stop-eta {
                    font-size: 6px;
                }
				/* Заголовок маршрута */
				.stop-info .route-title {
					font-size: 9px;
                .stop-info.forward-info {
                    font-size: 7px;
                    top: 15% !important;
                    left: 53% !important;
                    width: 30% !important;
                }

                .stop-info.backward-info {
                    font-size: 7px;
                    bottom: 0px !important;
                    left: 0px !important;
                    right: auto !important;
                    top: auto !important;
                    width: 27% !important;
                }
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Маршрут №414 - Текущее положение автобусов</h1>
        
        <div class="real-time" id="current-time"></div>
        
        <div class="map-wrapper" id="map-wrapper">
            <div class="map-container" id="combined-map">
                <!-- SVG будет вставлен динамически -->
                
                <!-- Панель расписания -->
                <div class="schedule-panel" id="schedule-panel">
                    <div class="schedule-header">
                        <h3 class="schedule-title" id="schedule-title"></h3>
                        <button class="close-schedule" id="close-schedule">×</button>
                    </div>
                    <div id="schedule-times"></div>
                    <div class="next-bus-info" id="next-bus-info"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ROUTE_DATA = {
            forward: {
                name: "Маршрут №414: Бронницы → МЦД Отдых",
                stops: [
                    {
                        name: "Парковка",
                        position: 0,
                        times: ["05:34", "06:04", "07:39", "08:09", "09:54", "10:34", "12:54", "14:29", "16:04", "16:43", "18:19"],
						hidden: true ,
						stopDuration: 60
                    },{
						name: "Автостанция Бронницы",
						position: 1.5,
						times: ["05:35", "06:05", "07:50", "08:30", "10:50", "11:40", "13:55", "14:39", "16:20", "17:30", "19:30"]
					},{
                        name: "Хозяйственный магазин",
                        position: 3,
                        times: ["05:37", "06:07", "07:52", "08:32", "10:52", "11:42", "13:57", "14:41", "16:22", "17:32", "19:32"]
                    },{
                        name: "Совхоз Бронницкий",
                        position: 5,
                        times: ["05:38", "06:08", "07:53", "08:33", "10:53", "11:43", "13:58", "14:42", "16:23", "17:33", "19:33"]
                    },{ 
						name: "Военная часть № 63539", 
						position: 6.5, 
						times: ["05:39", "06:09", "07:54", "08:34", "10:54", "11:44", "13:59", "14:43", "16:24", "17:34", "19:34"] 
					},{
						name: "Нижнее Велино", 
						position: 8.6, 
						times: ["05:41", "06:11", "07:56", "08:36", "10:56", "11:46", "14:01", "14:45", "16:26", "17:36", "19:36"] 
					},{ 
						name: "Верхнее Велино", 
						position: 11.5, 
						times: ["05:43", "06:13", "07:58", "08:38", "10:58", "11:48", "14:03", "14:47", "16:28", "17:38", "19:38"] 
					},{ 
						name: "Кривцы-1", 
						position: 15, 
						times: ["05:45", "06:15", "08:00", "08:40", "11:00", "11:50", "14:05", "14:49", "16:30", "17:40", "19:40"] 
					},{ 
						name: "Кривцы-2", 
						position: 16.8, 
						times: ["05:46", "06:16", "08:01", "08:41", "11:01", "11:51", "14:06", "14:50", "16:31", "17:41", "19:41"]
					},{ 
						name: "Тимонино", 
						position: 20, 
						times: ["05:47", "06:17", "08:02", "08:42", "11:02", "11:52", "14:07", "14:51", "16:32", "17:42", "19:42"] 
					},{ 
						name: "Тимонино-Баня", 
						position: 22, 
						times: ["05:48", "06:18", "08:03", "08:43", "11:03", "11:53", "14:08", "14:52", "16:33", "17:43", "19:43"] 
					},{ 
						name: "Софьино (трасса)", 
						position: 26, 
						times: ["05:50", "06:20", "08:05", "08:45", "11:05", "11:55", "14:10", "14:54", "16:35", "17:45", "19:45"] 
					},{ 
						name: "Софьино, 16", 
						position: 29, 
						times: ["05:52", "06:22", "08:07", "08:47", "11:07", "11:57", "14:12", "14:56", "16:37", "17:47", "19:47"] 
					},{ 
						name: "Магазин", 
						position: 32.3, 
						times: ["05:54", "06:24", "08:09", "08:49", "11:09", "11:59", "14:14", "14:58", "16:39", "17:49", "19:49"] 
					},{ 
						name: "Улица Шаровка", 
						position: 34, 
						times: ["05:56", "06:26", "08:11", "08:51", "11:11", "12:01", "14:16", "15:00", "16:41", "17:51", "19:51"]
					},{ 
						name: "Паткино, 55", 
						position: 39, 
						times: ["05:59", "06:29", "08:14", "08:54", "11:14", "12:04", "14:19", "15:03", "16:44", "17:54", "19:54"] 
					},{ 
						name: "Шилово, 24", 
						position: 41.5, 
						times: ["06:00", "06:30", "08:15", "08:55", "11:15", "12:05", "14:20", "15:04", "16:45", "17:55", "19:55"] 
					},{ 
						name: "Дурниха, 58А", 
						position: 45, 
						times: ["06:03", "06:33", "08:18", "08:58", "11:18", "12:08", "14:23", "15:07", "16:48", "17:58", "19:58"]
					},{ 
						name: "Дачный массив", 
						position: 48, 
						times: ["06:04", "06:34", "08:19", "08:59", "11:19", "12:09", "14:24", "15:08", "16:49", "17:59", "19:59"] 
					},{ 
						name: "Михайловская Слобода", 
						position: 52.5, 
						times: ["06:07", "06:37", "08:22", "09:02", "11:22", "12:12", "14:27", "15:11", "16:52", "18:02", "20:02"] 
					},{ 
						name: "Совхоз имени Тельмана", 
						position: 55.5, 
						times: ["06:09", "06:39", "08:24", "09:04", "11:24", "12:14", "14:29", "15:13", "16:54", "18:04", "20:04"] 
					},{
						name: "Чулково-1", 
						position: 57.5, 
						times: ["06:10", "06:40", "08:25", "09:05", "11:25", "12:15", "14:30", "15:14", "16:55", "18:05", "20:05"] 
					},{ 
						name: "Чулково-2", 
						position: 58.5, 
						times: ["06:11", "06:41", "08:26", "09:06", "11:26", "12:16", "14:31", "15:15", "16:56", "18:06", "20:06"]
					},{ 
						name: "Новые дома",
						position: 60.5, 
						times: ["06:12", "06:42", "08:27", "09:07", "11:27", "12:17", "14:32", "15:16", "16:57", "18:07", "20:07"]
					},{ 
						name: "Улица Туполева", 
						position: 80, 
						times: ["06:19", "06:49", "08:34", "09:14", "11:34", "12:24", "14:39", "15:23", "17:04", "18:14", "20:14"] 
					},{
						name: "Площадь Громова (НетПосадки)", 
						position: 83, 
						times: ["06:20", "06:50", "08:35", "09:15", "11:35", "12:25", "14:40", "15:24", "17:05", "18:15", "20:15"]
					},{ 
						name: "Площадь Громова", 
						position: 84.7, 
						times: ["06:21", "06:51", "08:36", "09:16", "11:36", "12:26", "14:41", "15:25", "17:06", "18:16", "20:16"] 
					},{ 
						name: "Улица Амет-Хан Султана", 
						position: 87, 
						times: ["06:22", "06:52", "08:37", "09:17", "11:37", "12:27", "14:42", "15:26", "17:07", "18:17", "20:17"] 
					},{ 
						name: "Улица Чкалова", 
						position: 89, 
						times: ["06:23", "06:53", "08:38", "09:18", "11:38", "12:28", "14:43", "15:27", "17:08", "18:18", "20:18"] 
					},{ 
						name: "Улица Пушкина", 
						position: 91, 
						times: ["06:25", "06:55", "08:40", "09:20", "11:40", "12:30", "14:45", "15:29", "17:10", "18:20", "20:20"] 
					},{ 
						name: "Улица Семашко", 
						position: 94.5, 
						times: ["06:27", "06:57", "08:42", "09:22", "11:42", "12:32", "14:47", "15:31", "17:12", "18:22", "20:22"] 
					},{
                        name: "МЦД Отдых",
                        position: 99.7,
                        times: ["06:30", "07:00", "08:45", "09:25", "11:45", "12:35", "14:50", "15:34", "17:15", "18:25", "20:25"],
						stopDuration: 60
                    }
                ]
            },
            backward: {
                name: "Маршрут №414: МЦД Отдых → Бронницы",
                stops: [
                    {
                        name: "Парковка",
                        position: 0,
                        times: ["06:31", "07:01", "08:46", "09:26", "11:46", "12:36", "14:51", "15:35", "17:16", "18:26", "20:26"],
						hidden: true ,
						stopDuration: 60
                    },{
                        name: "МЦД Отдых",
                        position: 1,
                        times: ["06:40", "07:10", "08:55", "09:35", "11:55", "13:30", "15:05", "15:44", "17:20", "18:50", "20:30"]
                    },{ 
						name: "Школа №8", 
						position: 3, 
						times: ["06:41", "07:11", "08:56", "09:36", "11:56", "13:31", "15:06", "15:45", "17:21", "18:51", "20:31"] 
					},{ 
						name: "Улица Жуковского", 
						position: 5.2, 
						times: ["06:43", "07:13", "08:58", "09:38", "11:58", "13:33", "15:08", "15:47", "17:23", "18:53", "20:33"] 
					},{ 
						name: "Больница", 
						position: 7, 
						times: ["06:44", "07:14", "08:59", "09:39", "11:59", "13:34", "15:09", "15:48", "17:24", "18:54", "20:34"] 
					},{ 
						name: "Улица Горького", 
						position: 9, 
						times: ["06:45", "07:15", "09:00", "09:40", "12:00", "13:35", "15:10", "15:49", "17:25", "18:55", "20:35"] 
					},{ 
						name: "Улица Пушкина", 
						position: 11, 
						times: ["06:46", "07:16", "09:01", "09:41", "12:01", "13:36", "15:11", "15:50", "17:26", "18:56", "20:36"] 
					},{
						name: "Улица Чкалова", 
						position: 13, 
						times: ["06:48", "07:18", "09:03", "09:43", "12:03", "13:38", "15:13", "15:52", "17:28", "18:58", "20:38"] 
					},{ 
						name: "Улица Амет-Хан Султана", 
						position: 15, 
						times: ["06:49", "07:19", "09:04", "09:44", "12:04", "13:39", "15:14", "15:53", "17:29", "18:59", "20:39"] 
					},{ 
						name: "Площадь Громова", 
						position: 17, 
						times: ["06:50", "07:20", "09:05", "09:45", "12:05", "13:40", "15:15", "15:54", "17:30", "19:00", "20:40"] 
					},{ 
						name: "Улица Туполева", 
						position: 19, 
						times: ["06:51", "07:21", "09:06", "09:46", "12:06", "13:41", "15:16", "15:55", "17:31", "19:01", "20:41"] 
					},{ 
						name: "светофор",
						position: 41, 
						times: ["06:57", "07:27", "09:12", "09:52", "12:12", "13:47", "15:22", "16:01", "17:37", "19:07", "20:47"],
						hidden: true ,
						stopDuration: 20
					},{ 
						name: "Новые дома",
						position: 42.1, 
						times: ["06:59", "07:29", "09:14", "09:54", "12:14", "13:49", "15:24", "16:03", "17:39", "19:09", "20:49"]
					},{ 
						name: "Чулково-2", 
						position: 44, 
						times: ["07:00", "07:30", "09:15", "09:55", "12:15", "13:50", "15:25", "16:04", "17:40", "19:10", "20:50"]
					},{
						name: "Чулково-1", 
						position: 45, 
						times: ["07:01", "07:31", "09:16", "09:56", "12:16", "13:51", "15:26", "16:05", "17:41", "19:11", "20:51"] 
					},{ 
						name: "Совхоз имени Тельмана", 
						position: 47, 
						times: ["07:03", "07:33", "09:18", "09:58", "12:18", "13:53", "15:28", "16:07", "17:43", "19:13", "20:53"] 
					},{ 
						name: "Михайловская Слобода", 
						position: 49.6, 
						times: ["07:04", "07:34", "09:19", "09:59", "12:19", "13:54", "15:29", "16:08", "17:44", "19:14", "20:54"] 
					},{ 
						name: "Дачный массив", 
						position: 54, 
						times: ["07:07", "07:37", "09:22", "10:02", "12:22", "13:57", "15:32", "16:11", "17:47", "19:17", "20:57"] 
					},{ 
						name: "Поворот", 
						position: 55, 
						times: ["07:08", "07:38", "09:23", "10:03", "12:23", "13:58", "15:33", "16:12", "17:48", "19:18", "20:58"]
					},{ 
						name: "Дурниха, 58А", 
						position: 57, 
						times: ["07:09", "07:39", "09:24", "10:04", "12:24", "13:59", "15:34", "16:13", "17:49", "19:19", "20:59"]
					},{ 
						name: "Шилово, 24", 
						position: 59.8, 
						times: ["07:11", "07:41", "09:26", "10:06", "12:26", "14:01", "15:36", "16:15", "17:51", "19:21", "21:01"] 
					},{ 
						name: "Паткино, 55", 
						position: 62.7, 
						times: ["07:13", "07:43", "09:28", "10:08", "12:28", "14:03", "15:38", "16:17", "17:53", "19:23", "21:03"] 
					},{ 
						name: "Улица Шаровка", 
						position: 67, 
						times: ["07:15", "07:45", "09:30", "10:10", "12:30", "14:05", "15:40", "16:19", "17:55", "19:25", "21:05"]
					},{ 
						name: "Магазин", 
						position: 68.3, 
						times: ["07:17", "07:47", "09:32", "10:12", "12:32", "14:07", "15:42", "16:21", "17:57", "19:27", "21:07"] 
					},{ 
						name: "Софьино, 16", 
						position: 70.9, 
						times: ["07:19", "07:49", "09:34", "10:14", "12:34", "14:09", "15:44", "16:23", "17:59", "19:29", "21:09"] 
					},{ 
						name: "РЦ Перекресток", 
						position: 72.5, 
						times: ["07:21", "07:51", "09:36", "10:16", "12:36", "14:11", "15:46", "16:25", "18:01", "19:31", "21:11"] 
					},{ 
						name: "Софьино (трасса)", 
						position: 76, 
						times: ["07:22", "07:52", "09:37", "10:17", "12:37", "14:12", "15:47", "16:26", "18:02", "19:32", "21:12"] 
					},{ 
						name: "Тимонино-Баня", 
						position: 81, 
						times: ["07:25", "07:55", "09:40", "10:20", "12:40", "14:15", "15:50", "16:29", "18:05", "19:35", "21:15"] 
					},{ 
						name: "Тимонино", 
						position: 82.8, 
						times: ["07:26", "07:56", "09:41", "10:21", "12:41", "14:16", "15:51", "16:30", "18:06", "19:36", "21:16"] 
					},{ 
						name: "Кривцы-2", 
						position: 85.2, 
						times: ["07:27", "07:57", "09:42", "10:22", "12:42", "14:17", "15:52", "16:31", "18:07", "19:37", "21:17"] 
					},{ 
						name: "Кривцы-1", 
						position: 87.3, 
						times: ["07:28", "07:58", "09:43", "10:23", "12:43", "14:18", "15:53", "16:32", "18:08", "19:38", "21:18"] 
					},{ 
						name: "Верхнее Велино", 
						position: 90.8, 
						times: ["07:30", "08:00", "09:45", "10:25", "12:45", "14:20", "15:55", "16:34", "18:10", "19:40", "21:20"] 
					},{
						name: "Нижнее Велино", 
						position: 93, 
						times: ["07:32", "08:02", "09:47", "10:27", "12:47", "14:22", "15:57", "16:36", "18:12", "19:42", "21:22"] 
					},{ 
						name: "Военная часть № 63539", 
						position: 95.6, 
						times: ["07:33", "08:03", "09:48", "10:28", "12:48", "14:23", "15:58", "16:37", "18:13", "19:43", "21:23"] 
					},{ 
						name: "Совхоз Бронницкий", 
						position: 97, 
						times: ["07:35", "08:05", "09:50", "10:30", "12:50", "14:25", "16:00", "16:39", "18:15", "19:45", "21:25"] 
					},{
						name: "Хозяйственны магазин",
						position: 98.9,
						times: ["07:36", "08:06", "09:51", "10:31", "12:51", "14:26", "16:01", "16:40", "18:16", "19:46", "21:26"]
					},{
						name: "Автостанция Бронницы",
                        position: 100,
                        times: ["07:38", "08:08", "09:53", "10:33", "12:53", "14:28", "16:03", "16:42", "18:18", "19:48", "21:28"],
						stopDuration: 60
                    }
                ]
            }
        };

        // SVG данные для разных устройств
        const SVG_DATA = {
            desktop: `
                <svg viewBox="0 0 400 280" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                    <path id="forward-path" stroke="#3498db" stroke-width="1" fill="none"
                        d="m 281.27584,233.99232 1.86788,-7.35289 -11.18858,-1.76398 -18.33925,4.21278 -14.58022,-4.49736 -10.71828,-7.07259 -18.76491,-21.16344 -27.16632,-6.51773 -7.24567,0.40048 -7.60405,-4.33544 12.83975,-16.11485 -0.4613,-10.87084 -29.16978,-9.55243 -15.32324,1.09385 -17.08994,-4.45525 -7.80806,0.13098 -2.10457,7.56663 -5.73958,-1.59252 -1.12733,2.82346 -36.203757,-8.03975 -23.578009,-10.48305 4.209142,-15.13327 13.992614,-13.90268 7.454365,-4.58806 7.381055,0.90087 5.886433,6.56938 7.022928,6.36372 5.870075,4.25137 3.53059,2.22612 8.056104,-3.3609 25.37756,-14.59985 -1.59292,-1.60022 -7.68131,1.21063 L 92.571234,83.420658 100.91649,60.929127 83.395967,58.784084"/>
                    <path id="backward-path" stroke="#9b59b6" stroke-width="1" fill="none"
                        d="m 77.377377,60.507337 3.939196,0.842666 0.49033,-2.647183 -7.024108,-1.389699 -4.860158,14.338361 21.557177,13.644096 28.905026,21.330222 3.57097,-0.67966 -20.7769,11.50595 -9.58966,3.56746 -8.049196,-6.39374 -5.868173,-5.49961 -6.785793,-8.15336 -6.234292,-0.49178 -8.14228,4.71638 -14.793616,14.75715 -4.618638,16.61855 -9.30364,-2.86128 11.199554,5.12814 23.697126,10.53576 38.487668,8.56986 1.09104,-2.7687 6.01756,1.70411 2.21742,-8.20905 5.61379,-0.0928 16.98927,4.48023 15.38641,-1.01994 26.89054,8.80306 0.34682,8.11147 -12.58939,15.83302 -2.46734,3.41707 -3.71203,-2.98071 0.8608,-1.22029 3.87937,2.59394 10.82967,6.28486 7.61271,-0.4226 25.90436,6.19473 18.61132,20.88419 11.33535,7.54305 15.40016,4.7276 18.521,-4.2988 9.51385,1.47714"/>
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.1"
					   id="path3079"
					   ry="54.106346"
					   rx="38.209118"
					   cy="127.93889"
					   cx="34.116985"
					   transform="rotate(-37.654592)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0276859"
					   id="path3079-8"
					   ry="17.752039"
					   rx="8.9264936"
					   cy="91.437416"
					   cx="-111.74687"
					   transform="matrix(0.26494302,-0.96426407,0.91151354,0.41127007,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0227689"
					   id="path3079-8-4"
					   ry="14.060909"
					   rx="8.969161"
					   cy="109.07296"
					   cx="-123.45049"
					   transform="matrix(0.18993041,-0.98179755,0.97171242,0.23616726,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0227689"
					   id="path3079-8-4-3"
					   ry="9.181304"
					   rx="11.471568"
					   cy="138.59613"
					   cx="-115.68983"
					   transform="matrix(0.18993041,-0.98179755,0.97171242,0.23616726,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0227689"
					   id="path3079-8-4-31"
					   ry="7.4057221"
					   rx="7.4480591"
					   cy="154.95758"
					   cx="-114.48309"
					   transform="matrix(0.18993041,-0.98179755,0.97171242,0.23616726,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0227689"
					   id="path3079-8-4-1"
					   ry="9.4919405"
					   rx="8.4277849"
					   cy="171.49184"
					   cx="-111.79919"
					   transform="matrix(0.18993041,-0.98179755,0.97171242,0.23616726,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0449523"
					   id="path3079-8-4-1-6"
					   ry="16.392767"
					   rx="16.728046"
					   cy="211.20316"
					   cx="-126.20156"
					   transform="matrix(0.21990651,-0.97552095,0.97845171,0.20647578,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0295496"
					   id="path3079-8-4-1-63"
					   ry="12.379103"
					   rx="10.884255"
					   cy="225.35275"
					   cx="-135.99597"
					   transform="matrix(0.16197651,-0.98679461,0.96480934,0.26295043,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0308562"
					   id="path3079-8-4-1-4"
					   ry="12.929214"
					   rx="11.363173"
					   cy="250.26732"
					   cx="-137.96263"
					   transform="matrix(0.16076639,-0.98699249,0.96449781,0.26409083,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0304621"
					   id="path3079-8-4-1-7"
					   ry="12.795746"
					   rx="11.190205"
					   cy="271.07791"
					   cx="-152.61115"
					   transform="matrix(0.14636094,-0.98923125,0.96071175,0.27754808,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0227689"
					   id="path3079-8-4-1-0"
					   ry="30.100651"
					   rx="25.96554"
					   cy="372.97598"
					   cx="-0.14336601"
					   transform="matrix(0.58360642,-0.81203667,0.78351655,0.62137092,0,0)" />
					<text
					   xml:space="preserve"
					   style="font-size:8px;line-height:9.14288px;font-family:ink_Assya;-inkscape-font-specification:ink_Assya;text-decoration-color:#000000;letter-spacing:0px;word-spacing:0px;fill:#000000;stroke-width:0.264583;-inkscape-stroke:none;stop-color:#000000"
					   x="105.29728"
					   y="13.091502"
					   id="text1360"
					   transform="rotate(43.955073)"><tspan
						 sodipodi:role="line"
						 id="tspan1358"
						 style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:8px;font-family:Arial;-inkscape-font-specification:Arial;stroke-width:0.264583"
						 x="105.29728"
						 y="13.091502">Жуковский</tspan></text>
					<text
					   xml:space="preserve"
					   style="font-size:7px;line-height:8px;font-family:ink_Assya;-inkscape-font-specification:ink_Assya;text-decoration-color:#000000;letter-spacing:0px;word-spacing:0px;fill:#000000;stroke-width:0.264583;-inkscape-stroke:none;stop-color:#000000"
					   x="279.13629"
					   y="245.83452"
					   id="text3729"><tspan
						 sodipodi:role="line"
						 id="tspan3727"
						 style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:7px;font-family:Arial;-inkscape-font-specification:Arial;stroke-width:0.264583"
						 x="279.13629"
						 y="245.83452">Бронницы</tspan></text>
					<path
					   style="fill:none;fill-opacity:0.08;stroke:#000000;stroke-width:0.6;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0"
					   d="m -40.411151,100.45654 c 0,0 42.7735977,15.07346 74.578669,26.67296 31.805073,11.5995 50.177367,19.92219 70.757122,28.52826 20.57975,8.60608 56.73098,26.34741 82.54921,43.93374 25.81824,17.58634 126.46091,112.09822 126.46091,112.09822"
					   id="path6121"
					   sodipodi:nodetypes="csssc" />
                </svg>
            `,
            mobile: `
                <svg viewBox="0 0 280 400" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                    <!-- Повёрнутые пути маршрутов -->
                    <path id="forward-path" stroke="#3498db" stroke-width="1" fill="none"
                        d="m 193.23668,356.3047 7.59295,-5.95191 -9.89445,-10.46822 -21.73713,-10.00596 -11.1857,-15.85516 -5.29678,-15.44767 -2.45132,-35.88587 -22.28813,-27.66725 -7.60624,-5.22582 -4.28776,-10.27247 25.44678,-6.24973 7.98096,-11.30332 -21.94764,-32.27909 -16.27756,-10.80306 -13.745254,-17.76252 -7.96305,-5.93412 -7.99731,5.98324 -4.541507,-6.06239 -3.32851,1.96692 L 43.504376,100.85959 27.909724,71.987693 43.90435,60.021267 68.793136,56.89442 l 11.069575,1.171837 6.731507,6.641233 0.822925,11.187241 2.126933,11.86311 2.60729,8.840715 1.82522,4.984154 10.722064,2.87484 36.8931,5.01602 -0.36061,-2.84864 -8.67425,-4.7486 -12.3349,-43.771465 25.8756,-16.161584 -15.97362,-15.771077"/>
                    <path id="backward-path" stroke="#9b59b6" stroke-width="1" fill="none"
                         d="m 122.72554,23.23146 3.31142,3.90871 2.55024,-2.284301 -5.99239,-6.856094 -16.03256,10.660348 11.10429,30.484539 12.53105,43.931498 4.12336,2.08992 -29.85742,-4.55683 L 92.036986,96.750981 88.900096,84.060365 87.26447,73.96437 86.76662,60.483656 80.871882,55.145197 69.01001,53.56813 42.650946,56.932974 25.09013,70.076691 17.945938,59.968052 l 7.291948,13.863856 15.673641,29.017502 32.092288,38.52879 3.249441,-1.93999 4.734685,6.3907 8.610025,-6.54236 5.72416,4.26783 13.624494,17.70946 16.28372,10.92656 20.23504,29.75391 -5.95251,8.43619 -24.97576,6.16049 -5.13882,1.52353 -1.42168,-5.88485 1.8147,-0.55987 1.89062,5.62545 6.02091,14.7411 7.99297,5.48871 21.26849,26.36164 2.51362,35.48541 5.55256,16.40072 11.83237,16.72396 21.98695,10.06057 8.43116,8.87835"/>
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.12717"
					   id="path3079"
					   ry="68.807243"
					   rx="48.590679"
					   cy="64.898743"
					   cx="135.21436" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0352083"
					   id="path3079-8"
					   ry="22.575336"
					   rx="11.351856"
					   cy="93.114716"
					   cx="-13.513334"
					   transform="matrix(0.79882621,-0.60156188,0.4704077,0.8824492,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0289553"
					   id="path3079-8-4"
					   ry="17.881313"
					   rx="11.406116"
					   cy="126.05117"
					   cx="-24.0336"
					   transform="matrix(0.75014933,-0.66126846,0.6250379,0.7805944,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0289553"
					   id="path3079-8-4-3"
					   ry="11.6759"
					   rx="14.588436"
					   cy="163.59589"
					   cx="-14.164363"
					   transform="matrix(0.75014933,-0.66126846,0.6250379,0.7805944,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0289553"
					   id="path3079-8-4-31"
					   ry="9.4178848"
					   rx="9.4717245"
					   cy="184.40283"
					   cx="-12.629735"
					   transform="matrix(0.75014933,-0.66126846,0.6250379,0.7805944,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0289553"
					   id="path3079-8-4-1"
					   ry="12.070936"
					   rx="10.717646"
					   cy="205.4295"
					   cx="-9.21663"
					   transform="matrix(0.75014933,-0.66126846,0.6250379,0.7805944,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.057166"
					   id="path3079-8-4-1-6"
					   ry="20.846743"
					   rx="21.273119"
					   cy="251.85907"
					   cx="-27.153204"
					   transform="matrix(0.77004727,-0.63798684,0.64851197,0.76120446,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0375783"
					   id="path3079-8-4-1-63"
					   ry="15.742552"
					   rx="13.84155"
					   cy="277.68878"
					   cx="-40.001526"
					   transform="matrix(0.73107071,-0.68230171,0.60321085,0.79758177,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.03924"
					   id="path3079-8-4-1-4"
					   ry="16.442131"
					   rx="14.45059"
					   cy="309.53528"
					   cx="-42.495998"
					   transform="matrix(0.73023353,-0.68319763,0.60226754,0.79829432,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0387388"
					   id="path3079-8-4-1-7"
					   ry="16.272398"
					   rx="14.230626"
					   cy="337.94028"
					   cx="-60.999939"
					   transform="matrix(0.72019628,-0.69377036,0.59104905,0.80663562,0,0)" />
					<ellipse
					   style="fill:#000000;fill-opacity:0.0485714;stroke:#000000;stroke-width:0.0289553"
					   id="path3079-8-4-1-0"
					   ry="38.27911"
					   rx="33.020477"
					   cy="406.83026"
					   cx="112.6144"
					   transform="matrix(0.95811886,-0.28637084,0.2407209,0.97059438,0,0)" />
					<text
					   xml:space="preserve"
					   style="font-size:7.63022px;line-height:8.72027px;font-family:ink_Assya;-inkscape-font-specification:ink_Assya;text-decoration-color:#000000;letter-spacing:0px;word-spacing:0px;fill:#000000;stroke-width:0.336472;-inkscape-stroke:none;stop-color:#000000"
					   x="138.94206"
					   y="69.791656"
					   id="text2616"><tspan
						 sodipodi:role="line"
						 id="tspan2614"
						 style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:7.63022px;font-family:Arial;-inkscape-font-specification:Arial;stroke-width:0.336472"
						 x="138.94206"
						 y="69.791656">Жуковский</tspan></text>
					<text
					   xml:space="preserve"
					   style="font-size:6.35852px;line-height:7.26689px;font-family:ink_Assya;-inkscape-font-specification:ink_Assya;text-decoration-color:#000000;letter-spacing:0px;word-spacing:0px;fill:#000000;stroke-width:0.336472;-inkscape-stroke:none;stop-color:#000000"
					   x="194.27489"
					   y="367.07788"
					   id="text5782"><tspan
						 sodipodi:role="line"
						 id="tspan5780"
						 style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:6.35852px;font-family:Arial;-inkscape-font-specification:Arial;stroke-width:0.336472"
						 x="194.27489"
						 y="367.07788">Бронницы</tspan></text>
					<path
					   style="fill:none;fill-opacity:1;stroke:#000000;stroke-width:0.12717;stroke-miterlimit:4;stroke-dasharray:none"
					   d="m -26.929977,-11.217065 c 0,0 48.060116,62.811241 55.673599,75.183152 7.613484,12.37191 39.494946,61.383713 54.246071,86.603373 14.751123,25.21967 26.497927,56.14945 33.159717,73.75564 20.17608,55.85179 23.50799,119.21419 22.03804,182.24776 -3.33089,15.22696 -4.75842,19.98538 -4.75842,19.98538"
					   id="path7834"
					   sodipodi:nodetypes="cssccc" />
                </svg>
            `
        };

class BusTracker {
    constructor() {
        this.mapWrapper = document.getElementById('map-wrapper');
        this.mapContainer = document.getElementById('combined-map');
        this.currentTimeElement = document.getElementById('current-time');
        this.schedulePanel = document.getElementById('schedule-panel');
        this.scheduleTitle = document.getElementById('schedule-title');
        this.scheduleTimes = document.getElementById('schedule-times');
        this.nextBusInfo = document.getElementById('next-bus-info');
        this.closeScheduleBtn = document.getElementById('close-schedule');
        
        this.buses = { forward: [], backward: [] };
        this.pathCache = { forward: [], backward: [] };
        this.currentSchedule = null;
        this.isMobile = window.innerWidth < 768;
        this.arrows = [];
        this.resizeTimeout = null;
        this.animationFrameId = null;
        this.updateInterval = null;
        
        this.initOverlayContainer();
        this.init();
    }
    
    initOverlayContainer() {
        this.overlayContainer = document.createElement('div');
        this.overlayContainer.className = 'overlay-container';
        this.mapContainer.appendChild(this.overlayContainer);
    }
    
    init() {
        this.setupLayout();
        this.loadSVG().then(() => {
            this.cachePathPoints();
            this.createStopElements();
            this.createAllBusElements();
            this.setupEventListeners();
            this.startAnimation();
            this.startUpdateInterval();
        });
    }
    
    setupLayout() {
        this.isMobile = window.innerWidth < 768;
        this.mapWrapper.className = `map-wrapper ${this.isMobile ? 'mobile' : 'desktop'}`;
    }

    loadSVG() {
        return new Promise((resolve) => {
            const oldSVG = this.mapContainer.querySelector('svg');
            if (oldSVG) oldSVG.remove();
            
            this.mapContainer.insertAdjacentHTML('afterbegin', 
                this.isMobile ? SVG_DATA.mobile : SVG_DATA.desktop);

            this.svg = this.mapContainer.querySelector('svg');
            this.forwardPath = document.getElementById('forward-path');
            this.backwardPath = document.getElementById('backward-path');
            
            resolve();
        });
    }
    
    setupEventListeners() {
        window.addEventListener('resize', () => {
            clearTimeout(this.resizeTimeout);
            this.resizeTimeout = setTimeout(() => {
                const newIsMobile = window.innerWidth < 768;
                if (newIsMobile !== this.isMobile) {
                    this.isMobile = newIsMobile;
                    this.setupLayout();
                    this.loadSVG().then(() => {
                        this.cachePathPoints();
                        this.updateAllPositions();
                    });
                }
            }, 200);
        });
        
        this.closeScheduleBtn.addEventListener('click', () => this.hideSchedule());
        this.mapContainer.addEventListener('click', (e) => {
            if (e.target === this.mapContainer) this.hideSchedule();
        });
    }
    
    cachePathPoints() {
        const cachePath = (path) => {
            if (!path) return [];
            const length = path.getTotalLength();
            const points = [];
            const segmentCount = 3000; // Увеличенная плотность точек
            
            for (let i = 0; i <= segmentCount; i++) {
                const point = path.getPointAtLength(length * i / segmentCount);
                points.push({
                    x: point.x,
                    y: point.y,
                    percentage: i / segmentCount * 100
                });
            }
            return points;
        };
        
        this.pathCache.forward = cachePath(this.forwardPath);
        this.pathCache.backward = cachePath(this.backwardPath);
    }
    
    createStopElements() {
        const createStops = (direction) => {
            this.overlayContainer.querySelectorAll(`.${direction}-stop`).forEach(el => el.remove());

            ROUTE_DATA[direction].stops.forEach((stop, index) => {
                if (stop.hidden) return;

                const stopElement = document.createElement('div');
                stopElement.className = `stop ${direction}-stop`;
                stopElement.dataset.direction = direction;
                stopElement.dataset.index = index;

                const label = document.createElement('div');
                label.className = 'stop-label';
                label.textContent = stop.name;

                this.overlayContainer.appendChild(stopElement);
                this.overlayContainer.appendChild(label);

                stopElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.showSchedule(direction, index);
                });
            });
        };

        createStops('forward');
        createStops('backward');
        this.updateStopPositions();
    }

    createAllBusElements() {
        const createBuses = (direction) => {
            this.overlayContainer.querySelectorAll(`.${direction}-bus`).forEach(el => el.remove());
            this.buses[direction] = [];
            
            const maxBuses = ROUTE_DATA[direction].stops[0].times.length;
            for (let i = 0; i < maxBuses; i++) {
                const bus = document.createElement('div');
                bus.className = `bus ${direction}-bus`;
                bus.style.display = 'none';
                this.overlayContainer.appendChild(bus);
                this.buses[direction].push(bus);
            }
        };

        createBuses('forward');
        createBuses('backward');
    }
    
    startAnimation() {
        const animate = () => {
            this.updateAllPositions();
            this.animationFrameId = requestAnimationFrame(animate);
        };
        animate();
    }
    
    startUpdateInterval() {
        this.updateInterval = setInterval(() => {
            this.updateCurrentTime();
            this.updateScheduleIfVisible();
        }, 1000);
        this.updateCurrentTime(); // Первоначальное обновление
    }
    
    updateCurrentTime() {
        const now = new Date();
        const timeStr = now.toTimeString().substr(0, 8);
        this.currentTimeElement.textContent = `Текущее время: ${timeStr}`;
        return now;
    }
    
    updateAllPositions() {
        this.clearAllArrows();
        this.updateStopPositions();
        this.updateBusPositions();
    }
    
    clearAllArrows() {
        this.arrows.forEach(arrow => arrow.remove());
        this.arrows = [];
    }
    
    updateStopPositions() {
        const positionStop = (direction, index) => {
            const stop = ROUTE_DATA[direction].stops[index];
            const stopElement = this.overlayContainer.querySelector(`.${direction}-stop[data-index="${index}"]`);
            if (!stopElement) return;

            const point = this.getPointAtPercentage(direction, stop.position);
            const { x, y } = this.convertToPixelPosition(point.x, point.y);
            
            stopElement.style.transform = `translate(${x}px, ${y}px)`;
            
            const label = stopElement.nextElementSibling;
            if (label?.classList.contains('stop-label')) {
                label.style.transform = `translate(${x}px, ${y - 15}px)`;
            }
        };

        ['forward', 'backward'].forEach(direction => {
            ROUTE_DATA[direction].stops.forEach((stop, index) => {
                if (!stop.hidden) positionStop(direction, index);
            });
        });
    }
    
    convertToPixelPosition(x, y) {
        if (!this.svg || !this.svg.viewBox?.baseVal) return { x: 0, y: 0 };
        
        const svgRect = this.svg.getBoundingClientRect();
        const viewBox = this.svg.viewBox.baseVal;
        
        return {
            x: (x / viewBox.width) * svgRect.width - 4,
            y: (y / viewBox.height) * svgRect.height - 4
        };
    }
    
    updateBusPositions() {
        this.updateRoutePositions('forward');
        this.updateRoutePositions('backward');
    }

    updateRoutePositions(direction) {
        const now = new Date();
        const currentSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        const route = ROUTE_DATA[direction];

        let activeBuses = [];

        route.stops[0].times.forEach((_, tripIndex) => {
            const bus = this.buses[direction][tripIndex];
            if (!bus) return;

            const [depH, depM] = route.stops[0].times[tripIndex].split(':').map(Number);
            const depSec = depH * 3600 + depM * 60;
            const [arrH, arrM] = route.stops[route.stops.length-1].times[tripIndex].split(':').map(Number);
            const arrSec = arrH * 3600 + arrM * 60;
            
            if (currentSec >= depSec && currentSec <= arrSec + 60) {
                bus.style.display = 'block';
                
                const { position, currentStopName, nextStopInfo, isAtStop } = 
                    this.calculateBusPosition(direction, tripIndex, currentSec);
                
                const point = this.getPointAtPercentage(direction, position);
                const { x, y } = this.convertToPixelPosition(point.x, point.y);
                
                bus.style.transform = `translate(${x}px, ${y}px)`;

                if (nextStopInfo || (isAtStop && currentStopName)) {
                    activeBuses.push({ 
                        isAtStop, 
                        currentStopName, 
                        nextStopInfo, 
                        x: x + 4,
                        y: y + 4,
                        direction,
                        tripIndex
                    });
                }
            } else {
                bus.style.display = 'none';
            }
        });

        if (activeBuses.length > 0) {
            this.updateBusInfoPanel(direction, activeBuses);
        } else {
            this.removeBusInfoPanel(direction);
        }
    }
    
    calculateBusPosition(direction, tripIndex, currentSec) {
        const route = ROUTE_DATA[direction];
        let position = 0;
        let currentStopName = "";
        let nextStopInfo = null;
        let isAtStop = false;

        for (let i = 0; i < route.stops.length; i++) {
            const stop = route.stops[i];
            const [stopH, stopM] = stop.times[tripIndex].split(':').map(Number);
            const stopSec = stopH * 3600 + stopM * 60;
            const stopDuration = stop.stopDuration || 20;
            const stopEndSec = stopSec + stopDuration;

            if (currentSec >= stopSec && currentSec < stopEndSec) {
                position = stop.position;
                currentStopName = stop.hidden ? "" : stop.name;
                isAtStop = true;
                
                const nextVisibleStop = this.findNextVisibleStop(route.stops, i + 1);
                if (nextVisibleStop) {
                    const [nextStopH, nextStopM] = nextVisibleStop.times[tripIndex].split(':').map(Number);
                    nextStopInfo = {
                        name: nextVisibleStop.name,
                        arrivalTime: nextVisibleStop.times[tripIndex],
                        minutesLeft: Math.ceil((nextStopH * 3600 + nextStopM * 60 - currentSec) / 60)
                    };
                }
                break;
            }
            else if (i > 0) {
                const prevStop = route.stops[i-1];
                const [prevStopH, prevStopM] = prevStop.times[tripIndex].split(':').map(Number);
                const prevStopEndSec = prevStopH * 3600 + prevStopM * 60 + (prevStop.stopDuration || 20);
                
                if (currentSec >= prevStopEndSec && currentSec < stopSec) {
                    const progress = (currentSec - prevStopEndSec) / (stopSec - prevStopEndSec);
                    position = prevStop.position + (stop.position - prevStop.position) * progress;
                    
                    const nextVisibleStop = this.findNextVisibleStop(route.stops, i);
                    if (nextVisibleStop) {
                        const [nextStopH, nextStopM] = nextVisibleStop.times[tripIndex].split(':').map(Number);
                        nextStopInfo = {
                            name: nextVisibleStop.name,
                            arrivalTime: nextVisibleStop.times[tripIndex],
                            minutesLeft: Math.ceil((nextStopH * 3600 + nextStopM * 60 - currentSec) / 60)
                        };
                    }
                    break;
                }
            }
        }
        
        return { position, currentStopName, nextStopInfo, isAtStop };
    }
    
    findNextVisibleStop(stops, startIndex) {
        for (let i = startIndex; i < stops.length; i++) {
            if (!stops[i].hidden) return stops[i];
        }
        return null;
    }
    
    updateBusInfoPanel(direction, activeBuses) {
        let infoPanel = this.overlayContainer.querySelector(`.${direction}-info`);
        if (!infoPanel) {
            infoPanel = document.createElement('div');
            infoPanel.className = `stop-info ${direction}-info`;
            this.overlayContainer.appendChild(infoPanel);
        }

        let content = `<div class="route-title">Маршрут ${direction === 'forward' ? 'Бронницы → МЦД Отдых' : 'МЦД Отдых → Бронницы'}</div>`;
        
        activeBuses.forEach((bus, index) => {
            if (index > 0) content += '<hr class="bus-separator">';
            
            if (bus.isAtStop && bus.currentStopName) {
                content += `
                    <div class="bus-info">
                        <div class="stop-time">${bus.currentStopName}</div>
                        <div class="stop-eta">${bus.nextStopInfo ? 
                            `Следующая: ${bus.nextStopInfo.name} в ${bus.nextStopInfo.arrivalTime}` : 'Конечная'}</div>
                    </div>
                `;
            } else if (bus.nextStopInfo) {
                content += `
                    <div class="bus-info">
                        <div class="stop-time">Следующая: ${bus.nextStopInfo.name}</div>
                        <div class="stop-eta">Прибытие в ${bus.nextStopInfo.arrivalTime} (через ${bus.nextStopInfo.minutesLeft} мин)</div>
                    </div>
                `;
            }
        });

        infoPanel.innerHTML = content;
        
        // Обновляем стрелки
        activeBuses.forEach(bus => {
            this.updateArrow(direction, bus.tripIndex, infoPanel, bus.x, bus.y);
        });
    }
    
    removeBusInfoPanel(direction) {
        const infoPanel = this.overlayContainer.querySelector(`.${direction}-info`);
        if (infoPanel) infoPanel.remove();
    }
    
    updateArrow(direction, tripIndex, fromElement, toX, toY) {
        let arrow = this.arrows.find(a => 
            a.dataset.direction === direction && a.dataset.tripIndex == tripIndex
        );

        if (!arrow) {
            arrow = this.createArrow(fromElement, toX, toY);
            arrow.dataset.direction = direction;
            arrow.dataset.tripIndex = tripIndex;
            this.arrows.push(arrow);
        } else {
            this.positionArrow(arrow, fromElement, toX, toY);
        }
    }
    
    createArrow(fromElement, toX, toY) {
        const fromRect = fromElement.getBoundingClientRect();
        const mapRect = this.mapContainer.getBoundingClientRect();
        
        const fromX = fromRect.left + fromRect.width / 2 - mapRect.left;
        const fromY = fromRect.top + fromRect.height / 2 - mapRect.top;
        
        const dx = toX - fromX;
        const dy = toY - fromY;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
        
        const arrow = document.createElement('div');
        arrow.className = 'arrow-line';
        arrow.style.cssText = `
            width: ${length}px;
            left: ${fromX}px;
            top: ${fromY}px;
            transform: rotate(${angle}deg);
            background-color: rgba(0,0,0,0.3);
            height: 2px;
            position: absolute;
            transform-origin: 0 50%;
        `;
        
        this.overlayContainer.appendChild(arrow);
        return arrow;
    }
    
    positionArrow(arrow, fromElement, toX, toY) {
        const fromRect = fromElement.getBoundingClientRect();
        const mapRect = this.mapContainer.getBoundingClientRect();
        
        const fromX = fromRect.left + fromRect.width / 2 - mapRect.left;
        const fromY = fromRect.top + fromRect.height / 2 - mapRect.top;
        
        const dx = toX - fromX;
        const dy = toY - fromY;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
        
        arrow.style.width = `${length}px`;
        arrow.style.left = `${fromX}px`;
        arrow.style.top = `${fromY}px`;
        arrow.style.transform = `rotate(${angle}deg)`;
    }

    getPointAtPercentage(direction, percentage) {
        const points = this.pathCache[direction];
        if (!points?.length) return { x: 0, y: 0 };
        
        const target = points.reduce((prev, curr) => 
            Math.abs(curr.percentage - percentage) < Math.abs(prev.percentage - percentage) ? curr : prev
        );
        
        return target || points[0];
    }

    showSchedule(direction, stopIndex) {
        const stop = ROUTE_DATA[direction].stops[stopIndex];
        if (stop.hidden) return;
        
        this.currentSchedule = { direction, stopIndex };
        this.updateSchedule(direction, stopIndex);
        this.schedulePanel.style.display = 'block';
    }
    
    updateSchedule(direction, stopIndex) {
        const stop = ROUTE_DATA[direction].stops[stopIndex];
        const now = new Date();
        const currentSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

        this.scheduleTitle.textContent = `${stop.name} → ${direction === 'forward' ? 'МЦД Отдых' : 'Бронницы'}`;
        this.scheduleTimes.innerHTML = '';

        let nextTrip = null;
        stop.times.forEach((time, index) => {
            const [h, m] = time.split(':').map(Number);
            const timeSec = h * 3600 + m * 60;
            const stopDuration = stop.stopDuration || 20;
            const isPast = currentSec > timeSec + stopDuration;
            const isCurrent = currentSec >= timeSec && currentSec <= timeSec + stopDuration;

            if (!nextTrip && timeSec > currentSec) {
                nextTrip = { time, minutesLeft: Math.ceil((timeSec - currentSec) / 60) };
            }

            const timeElement = document.createElement('div');
            timeElement.className = `schedule-item ${isPast ? 'past-time' : isCurrent ? 'current-time' : 'future-time'}`;
            timeElement.textContent = `${time} ${isCurrent ? '(сейчас)' : ''}`;
            this.scheduleTimes.appendChild(timeElement);
        });

        this.nextBusInfo.textContent = nextTrip 
            ? `Следующий автобус через ${this.formatTimeLeft(nextTrip.minutesLeft)} (в ${nextTrip.time})`
            : 'Рейсы на сегодня завершены';
    }
    
    formatTimeLeft(minutes) {
        if (minutes >= 60) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours} ${this.pluralize(hours, 'час', 'часа', 'часов')}${mins ? ` ${mins} ${this.pluralize(mins, 'минуту', 'минуты', 'минут')}` : ''}`;
        }
        return `${minutes} ${this.pluralize(minutes, 'минуту', 'минуты', 'минут')}`;
    }
    
    pluralize(n, one, few, many) {
        n = Math.abs(n) % 100;
        const n1 = n % 10;
        if (n > 10 && n < 20) return many;
        if (n1 > 1 && n1 < 5) return few;
        if (n1 === 1) return one;
        return many;
    }
    
    hideSchedule() {
        this.schedulePanel.style.display = 'none';
    }
    
    updateScheduleIfVisible() {
        if (this.schedulePanel.style.display === 'block' && this.currentSchedule) {
            const { direction, stopIndex } = this.currentSchedule;
            this.updateSchedule(direction, stopIndex);
        }
    }
    
    destroy() {
        cancelAnimationFrame(this.animationFrameId);
        clearInterval(this.updateInterval);
        clearTimeout(this.resizeTimeout);
        window.removeEventListener('resize', this.handleResize);
    }
}

        document.addEventListener('DOMContentLoaded', () => new BusTracker());
    </script>
</body>
</html>